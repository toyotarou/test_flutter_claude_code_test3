# Flutter 競馬成績アプリ 基本設計書

> **基本設計書とは？**
>
> 基本設計書は「何を作るか」を定義するドキュメントです。
> 詳細設計書（どう作るか）の **前段階** にあたります。
>
> **基本設計書と詳細設計書の違い:**
>
> | 観点 | 基本設計書 | 詳細設計書 |
> |---|---|---|
> | 読む人 | 発注者・PM・開発者 | 開発者 |
> | 書く内容 | 何を作るか（要件・機能） | どう作るか（実装方法） |
> | 技術の深さ | 技術に依存しない記述が理想 | 具体的な型名・関数名まで記載 |
> | 例 | 「馬名で検索できる」 | 「toKatakana()でカタカナ変換し、startsWith()で前方一致」 |
>
> 基本設計書は以下の観点で構成されます:
>
> | セクション | 書く内容 | なぜ必要か |
> |---|---|---|
> | 1. プロジェクト概要 | 背景・目的・スコープ | 「なぜこのアプリを作るのか」を共有するため |
> | 2. システム構成 | サーバー・クライアントの関係 | 全体の登場人物を明確にするため |
> | 3. 機能一覧 | アプリが持つ全機能のリスト | 「何ができて何ができないか」を合意するため |
> | 4. 機能要件 | 各機能の振る舞い | 開発者の「こう解釈した」を防ぐため |
> | 5. 画面一覧・遷移 | 画面の構成と流れ | ユーザー体験を設計するため |
> | 6. データ設計 | 扱うデータの種類と関係 | DB・API・UIの整合性を保つため |
> | 7. 外部インターフェース | API仕様の概要 | サーバーとの約束を定義するため |
> | 8. 非機能要件 | 性能・セキュリティ等 | 「動くけど遅い」を防ぐため |

---

## 1. プロジェクト概要

> **このセクションの目的：** 「なぜこのアプリを作るのか」「誰が使うのか」「どこまでが範囲か」を明確にする。プロジェクトに関わる全員が最初に読むセクション。

### 1.1 背景

競馬のレース結果は複数のWebサイトで公開されているが、特定の馬の過去成績を横断的に閲覧したり、成績の推移を視覚的に把握する手段が限られている。
個人学習を兼ねて、Go + Flutter の構成で競馬成績閲覧アプリを開発する。

### 1.2 目的

- 競馬のレース結果をモバイル端末から手軽に閲覧できるようにする
- 馬名で検索し、過去の成績推移をグラフで確認できるようにする
- Flutter / Go / REST API の学習教材としても活用する

### 1.3 対象ユーザー

- 開発者自身（個人利用）
- 競馬に興味がある知人（将来的な共有を想定）

### 1.4 スコープ（対象範囲）

> **補足：** スコープとは「このプロジェクトで作るもの・作らないもの」の境界線。これを書いておかないと、「あれも欲しい、これも欲しい」と際限なく膨らんでしまう（スコープクリープと呼ぶ）。

**対象範囲（作るもの）:**

- レース一覧の表示と年フィルタリング
- レース結果（着順・馬名・騎手・タイム）の表示
- 馬名による検索（ひらがな入力対応）
- 馬の過去成績一覧と着順推移グラフ
- 馬名一覧（あいうえお順グループ化）

**対象外（作らないもの）:**

- ユーザー認証（ログイン機能）
- データの登録・編集・削除（閲覧専用）
- プッシュ通知
- オフライン対応（キャッシュ機能）
- 予想機能・オッズ表示

---

## 2. システム構成

> **このセクションの目的：** アプリがどんな「部品」で成り立っているかを図示する。「クライアントとサーバーの関係」「どこに何があるか」を把握するための地図。

### 2.1 全体構成図

```
┌──────────────────────┐          ┌──────────────────────┐
│   モバイル端末         │          │   リモートサーバー      │
│  (Android / iOS)      │          │  (49.212.175.205)     │
│                       │          │                       │
│  ┌─────────────────┐ │  HTTP    │  ┌─────────────────┐  │
│  │  Flutter アプリ   │ │ ◄─────► │  │  Go APIサーバー   │  │
│  │                  │ │  JSON   │  │  (ポート 8080)    │  │
│  │  - 画面表示      │ │          │  │                  │  │
│  │  - ユーザー操作   │ │          │  │  - データ取得     │  │
│  │  - データ表示     │ │          │  │  - SQL実行       │  │
│  └─────────────────┘ │          │  └────────┬────────┘  │
│                       │          │           │           │
└──────────────────────┘          │  ┌────────▼────────┐  │
                                   │  │    MySQL         │  │
                                   │  │  (データベース)    │  │
                                   │  │                  │  │
                                   │  │  - レース情報     │  │
                                   │  │  - 出走結果       │  │
                                   │  └─────────────────┘  │
                                   └──────────────────────┘
```

### 2.2 各コンポーネントの役割

| コンポーネント | 技術 | 役割 |
|---|---|---|
| Flutterアプリ | Flutter (Dart) | ユーザーインターフェース。データの表示と操作を担当 |
| Go APIサーバー | Go (net/http) | データの取得・加工。DBへのアクセスを担当 |
| MySQL | MySQL | レース情報・出走結果の永続化 |

### 2.3 通信方式

| 項目 | 内容 |
|---|---|
| プロトコル | HTTP |
| データ形式 | JSON |
| 通信方向 | クライアント → サーバー（リクエスト/レスポンス型） |
| 認証 | なし（現時点では不要） |

---

## 3. 機能一覧

> **このセクションの目的：** アプリが持つ機能を一覧化する。各機能に番号を振ることで、後のセクションや議論で「F-03の仕様について」のように参照できる。

| 機能ID | 機能名 | 概要 | 優先度 |
|---|---|---|---|
| F-01 | レース一覧表示 | 全レースを日付順に一覧表示する | 必須 |
| F-02 | 年フィルタリング | 特定の年のレースだけに絞り込む | 必須 |
| F-03 | レース結果表示 | レースの着順・馬名・騎手・タイムを表示する | 必須 |
| F-04 | 馬名検索 | 馬名を入力して過去成績を検索する | 必須 |
| F-05 | ひらがな入力対応 | ひらがな入力をカタカナに自動変換して検索する | 必須 |
| F-06 | 検索サジェスト | 入力中にリアルタイムで候補を表示する | 重要 |
| F-07 | 馬名一覧表示 | 全馬名をあいうえお順にグループ化して表示する | 重要 |
| F-08 | 成績グラフ表示 | 馬の着順推移を折れ線グラフで表示する | 重要 |
| F-09 | アクティブ表示 | 最近出走がない馬をグレー表示で区別する | 任意 |
| F-10 | グレード表示 | G1/G2/G3を色分けバッジで表示する | 任意 |

> **補足：** 優先度は以下の基準で分類。
> - **必須:** これがないとアプリとして成り立たない
> - **重要:** なくても動くが、ユーザー体験が大幅に低下する
> - **任意:** あると嬉しいが、なくても支障ない

---

## 4. 機能要件

> **このセクションの目的：** 各機能の「振る舞い」を自然言語で定義する。「検索ってどう動くの？」という質問に答えるセクション。技術的な実装方法（どのライブラリを使うか等）は書かず、「ユーザーから見てどう動くか」を記述する。

### F-01 レース一覧表示

```
概要:   アプリ起動時に全レースを一覧表示する
入力:   なし（自動取得）
処理:   サーバーから全レース情報を取得する
出力:   日付昇順に並んだレースのリスト
```

**表示項目:**
- 開催日（YYYY/MM/DD）
- レース名
- グレード（G1/G2/G3/その他）
- 開催場所
- 年齢条件
- コース種別（芝/ダート）
- コース距離

**表示ルール:**
- 日付の昇順で表示する
- 同じ日のレースはレース名の昇順で表示する

**異常系:**
- 通信エラー時はエラーメッセージとリトライボタンを表示する
- データ取得中はローディングインジケータを表示する

### F-02 年フィルタリング

```
概要:   レース一覧を特定の年で絞り込む
入力:   年（画面上の年ボタンをタップ）
処理:   選択された年のレースのみ表示する
出力:   フィルタリングされたレースリスト
```

**動作ルール:**
- 未選択の年をタップ → その年で絞り込む
- 選択中の年を再タップ → フィルター解除（全年表示）
- 年を切り替えたとき、リストは先頭に戻る

### F-03 レース結果表示

```
概要:   レースをタップすると着順結果を表示する
入力:   レース（一覧からタップ）
処理:   サーバーからそのレースの結果を取得する
出力:   着順リスト
```

**表示項目:**
- 着順
- 馬名
- 馬齢
- 騎手名
- タイム

**表示ルール:**
- 着順の色分け: 1着=金、2着=銀、3着=銅、4着以下=グレー

**異常系:**
- 結果がない場合は「No results」と表示する

### F-04 馬名検索

```
概要:   馬名を入力してその馬の過去成績を検索する
入力:   馬名（テキスト入力）
処理:   サーバーで部分一致検索を行う
出力:   検索結果の成績リスト
```

**表示項目:**
- 着順
- グレードバッジ
- 開催日
- レース名
- タイム

**表示ルール:**
- 着順の色分け: 1着=金、2着=銀、3着=銅、4着以下=グレー
- 日付とレース名は縦に並べて表示する（レース名が省略されないように）

**異常系:**
- 該当する馬がない場合は「該当する馬が見つかりません」と表示する

### F-05 ひらがな入力対応

```
概要:   ひらがなで入力しても馬名を検索できる
入力:   ひらがなテキスト（例: "あーもんどあい"）
処理:   ひらがなをカタカナに自動変換する
出力:   カタカナに変換された検索文字列
```

**動作ルール:**
- 変換はリアルタイムで行う（サジェスト表示時）
- 検索実行時にもテキスト欄をカタカナに置き換える
- カタカナ以外の文字（英数字等）はそのまま残す

### F-06 検索サジェスト

```
概要:   テキスト入力中にリアルタイムで馬名候補を表示する
入力:   テキスト入力（1文字以上）
処理:   入力文字列で始まる馬名を絞り込む
出力:   候補リスト（馬名＋出走回数）
```

**動作ルール:**
- フィルタリングは前方一致（入力文字で始まる馬名のみ）
- 表示件数の制限はなし（該当する全件を表示）
- 候補をタップすると自動的に検索が実行される
- 入力を全て消すと候補リストも消える

**アクティブ表示:**
- 最終出走年が去年または今年 → 通常表示（白色）
- それ以外 → グレー表示
- 出走回数は常に表示する

### F-07 馬名一覧表示

```
概要:   全馬名をあいうえお順にグループ化して一覧表示する
入力:   一覧ボタンのタップ
処理:   サーバーから全馬名（統計情報付き）を取得する
出力:   あいうえお行でグループ化された馬名リスト
```

**グループ化ルール:**
- カタカナの行（ア行、カ行、サ行...）で分類する
- 濁音・半濁音は基本の行に含める（例: ガ行 → カ行）
- どの行にも該当しない場合は「その他」グループ

**表示項目:**
- グループ名（ア行、カ行、...）
- 馬名
- 出走回数（「N走」表記）

**アクティブ表示:**
- F-06と同じルール（去年・今年の出走有無で色分け）

**タップ時の動作:**
- 馬名をタップすると、その馬の検索結果（F-04）を表示する

### F-08 成績グラフ表示

```
概要:   馬の着順推移を折れ線グラフで可視化する
表示条件: 検索結果が2件以上ある場合のみ
入力:   馬名検索の結果データ
処理:   着順データを折れ線グラフとして描画する
出力:   着順推移グラフ
```

**グラフ仕様:**
- 縦軸: 着順（1着が上、20着が下）
- 横軸: レース日時（時系列順）
- 折れ線: 各レースの着順をつなぐ
- データポイント: 着順に応じた色分け（1着=金、2着=銀、3着=銅）

**横軸ラベル:**
- 年と月-日を2行で表示する
- 10件以下は全件表示、それ以上は間引いて表示
- 最初と最後のデータは必ず表示する

### F-09 アクティブ表示

```
概要:   最近出走していない馬を視覚的に区別する
判定ルール: 最終出走年 >= 今年 - 1 であればアクティブ
表示:   アクティブ → 通常色、非アクティブ → グレー
適用箇所: 検索サジェスト（F-06）、馬名一覧（F-07）
```

### F-10 グレード表示

```
概要:   レースのグレードを色分けバッジで表示する
表示ルール:
  - G1: 金色グラデーション + 発光エフェクト
  - G2: 銀色グラデーション
  - G3: 銅色グラデーション
  - その他: グレーグラデーション
適用箇所: レース一覧（F-01）、馬名検索結果（F-04）
```

---

## 5. 画面一覧と画面遷移

> **このセクションの目的：** アプリにどんな画面があり、ユーザーがどうやって画面を移動するかを定義する。デザイナーが画面数を把握したり、テスターがテストケースを洗い出すのに使う。

### 5.1 画面一覧

| 画面ID | 画面名 | 種別 | 概要 |
|---|---|---|---|
| S-01 | ホーム画面 | 画面 | レース一覧を表示するメイン画面 |
| S-02 | レース結果ダイアログ | ダイアログ | 特定レースの着順結果を表示 |
| S-03 | 馬名検索結果ダイアログ | ダイアログ | 馬の過去成績一覧とグラフを表示 |
| S-04 | 馬名一覧ダイアログ | ダイアログ | 全馬名をあいうえお順に表示 |

> **補足：** 「画面」と「ダイアログ」の違い。
> - **画面:** アプリの全面を占める。画面遷移で切り替わる
> - **ダイアログ:** 画面の上に重なって表示される。外をタップすると閉じる

### 5.2 画面遷移図

```
                    アプリ起動
                        │
                        ▼
               ┌────────────────┐
               │  S-01           │
               │  ホーム画面      │
               │                 │
               │  [レース一覧]    │
               │  [検索バー]      │
               │  [年フィルター]   │
               └────────────────┘
                 │     │      │
    ┌────────────┘     │      └──────────────┐
    │                  │                      │
    │ レースを          │ 検索実行 or           │ 一覧ボタン
    │ タップ            │ サジェスト選択         │ タップ
    ▼                  ▼                      ▼
┌──────────┐   ┌──────────────┐    ┌──────────────┐
│ S-02      │   │ S-03          │    │ S-04          │
│ レース結果 │   │ 馬名検索結果   │    │ 馬名一覧      │
│ ダイアログ │   │ ダイアログ     │    │ ダイアログ     │
│           │   │               │    │               │
│ [着順表]  │   │ [グラフ]      │    │ [ア行]        │
│           │   │ [成績リスト]  │    │ [カ行] ...    │
└──────────┘   └──────────────┘    └──────────────┘
                                        │
                                        │ 馬名をタップ
                                        ▼
                                   ┌──────────────┐
                                   │ S-03          │
                                   │ 馬名検索結果   │
                                   │ ダイアログ     │
                                   └──────────────┘
```

### 5.3 各遷移の詳細

| # | 遷移元 | 操作 | 遷移先 | 戻り方 |
|---|---|---|---|---|
| 1 | S-01 ホーム | レースをタップ | S-02 レース結果 | ダイアログ外タップ or 戻るボタン |
| 2 | S-01 ホーム | 検索ボタン or Enter | S-03 馬名検索結果 | ダイアログ外タップ or 戻るボタン |
| 3 | S-01 ホーム | サジェスト候補をタップ | S-03 馬名検索結果 | ダイアログ外タップ or 戻るボタン |
| 4 | S-01 ホーム | 一覧ボタン(📋)をタップ | S-04 馬名一覧 | ダイアログ外タップ or 戻るボタン |
| 5 | S-04 馬名一覧 | 馬名をタップ | S-03 馬名検索結果 | ダイアログ外タップ or 戻るボタン |

---

## 6. データ設計

> **このセクションの目的：** アプリが扱う「データ」の種類と関係を定義する。詳細設計書ではフィールドの型まで書くが、基本設計書では「どんなデータがあるか」「データ同士がどう関係するか」を概念レベルで記述する。

### 6.1 データの種類

| データ名 | 概要 | 主な項目 |
|---|---|---|
| レース情報 | 開催されたレースの基本情報 | 日付、レース名、グレード、開催場所、コース種別、距離 |
| レース結果 | レースの着順結果 | 着順、馬名、馬齢、騎手名、タイム |
| 馬名統計 | 馬ごとの出走統計 | 馬名、出走回数、最終出走年 |

### 6.2 データの関係

```
┌──────────────┐        ┌──────────────┐
│  レース情報    │        │  レース結果    │
│              │ 1    N │              │
│  - 日付       │────────│  - 着順       │
│  - レース名    │        │  - 馬名       │
│  - グレード    │        │  - 騎手名     │
│  - 場所       │        │  - タイム     │
│  - コース     │        │              │
└──────────────┘        └──────┬───────┘
                               │
                               │ 馬名で集計
                               ▼
                        ┌──────────────┐
                        │  馬名統計     │
                        │              │
                        │  - 馬名       │
                        │  - 出走回数   │
                        │  - 最終出走年  │
                        └──────────────┘
```

**関係の説明:**
- 1つのレースに対して、N件のレース結果がある（1対多の関係）
- 馬名統計は、レース結果を馬名で集計したデータ

### 6.3 データの取得タイミング

| データ | 取得タイミング | 保持方法 |
|---|---|---|
| レース情報 | アプリ起動時に全件取得 | Providerでキャッシュ |
| レース結果 | レースタップ時 or 検索実行時に都度取得 | Providerでキャッシュ（パラメータ別） |
| 馬名統計 | ホーム画面表示時に全件取得 | Providerでキャッシュ |

> **補足：** 「キャッシュ」とは一度取得したデータをメモリに保持し、同じデータを再度サーバーに問い合わせないようにする仕組み。Riverpod の Provider が自動的にこれを行う。

---

## 7. 外部インターフェース設計

> **このセクションの目的：** アプリが外部（サーバー）とやりとりする「窓口」を定義する。基本設計書ではエンドポイントの一覧と概要を記述し、詳細なリクエスト/レスポンスのフォーマットは詳細設計書に譲る。

### 7.1 API一覧

| API-ID | メソッド | エンドポイント | 概要 | 対応機能 |
|---|---|---|---|---|
| API-01 | GET | /getAllRace | 全レース情報を取得 | F-01, F-02 |
| API-02 | GET | /getAllHourseNames | 全馬名リストを取得 | (予備) |
| API-03 | GET | /getAllHourseNamesWithStats | 全馬名＋統計情報を取得 | F-06, F-07, F-09 |
| API-04 | GET | /getSelectedResult | 特定レースの結果を取得 | F-03 |
| API-05 | GET | /getResultByHourseName | 馬名で成績を検索 | F-04, F-08 |

### 7.2 通信シーケンス

> **補足：** シーケンス図とは、「誰が」「いつ」「何を」やりとりするかを時系列で示す図。矢印の向きでリクエストとレスポンスを区別する。

**アプリ起動時:**

```
Flutterアプリ                 Go APIサーバー               MySQL
    │                             │                        │
    │  GET /getAllRace             │                        │
    │────────────────────────────►│                        │
    │                             │  SELECT * FROM races   │
    │                             │───────────────────────►│
    │                             │  結果セット              │
    │                             │◄───────────────────────│
    │  JSON (レース一覧)           │                        │
    │◄────────────────────────────│                        │
    │                             │                        │
    │  GET /getAllHourseNamesWithStats                      │
    │────────────────────────────►│                        │
    │                             │  SELECT + GROUP BY     │
    │                             │───────────────────────►│
    │                             │  結果セット              │
    │                             │◄───────────────────────│
    │  JSON (馬名統計)             │                        │
    │◄────────────────────────────│                        │
```

**馬名検索時:**

```
ユーザー          Flutterアプリ              Go APIサーバー
  │                   │                         │
  │ "あーもんど" 入力   │                         │
  │──────────────────►│                         │
  │                   │ (カタカナ変換)             │
  │                   │ "アーモンド" で前方一致     │
  │  候補リスト表示     │ (ローカルフィルタリング)    │
  │◄──────────────────│                         │
  │                   │                         │
  │ 候補をタップ        │                         │
  │──────────────────►│                         │
  │                   │ GET /getResultByHourseName│
  │                   │ ?hourse_name=アーモンドアイ │
  │                   │────────────────────────►│
  │                   │                         │
  │                   │ JSON (成績一覧)           │
  │                   │◄────────────────────────│
  │  検索結果表示       │                         │
  │◄──────────────────│                         │
```

> **ポイント：** サジェスト候補の表示はサーバーに問い合わせず、起動時に取得済みの馬名リストからローカルでフィルタリングしている。これにより入力のたびに通信が発生せず、即座に候補が表示される。

---

## 8. 非機能要件

> **このセクションの目的：** 「動くこと」以外の品質要件を定義する。機能要件が「何ができるか」なら、非機能要件は「どれくらいの品質で動くか」を定義するもの。
>
> **補足：** 非機能要件は以下のような観点がある。個人開発では全てを厳密に定義する必要はないが、意識しておくと品質の高いアプリになる。

### 8.1 性能要件

| 項目 | 要件 | 補足 |
|---|---|---|
| 初期表示 | 3秒以内にレース一覧を表示 | ネットワーク環境に依存 |
| 検索サジェスト | 入力から100ms以内に候補表示 | ローカル処理のため高速 |
| ダイアログ表示 | タップから2秒以内に結果表示 | API応答時間に依存 |

### 8.2 可用性要件

| 項目 | 要件 |
|---|---|
| サーバー停止時 | エラーメッセージとリトライボタンを表示。アプリはクラッシュしない |
| ネットワーク切断時 | ローディング表示のまま待機。復帰後にリトライ可能 |

### 8.3 ユーザビリティ要件

| 項目 | 要件 |
|---|---|
| 画面方向 | 縦固定（横回転しない） |
| キーボード | 画面タップで閉じる |
| テーマ | ダークテーマ統一 |
| 文字入力 | ひらがな入力でも検索可能 |
| ローディング | データ取得中はスピナーを表示し、ユーザーに待機中であることを伝える |

### 8.4 保守性要件

| 項目 | 要件 |
|---|---|
| API接続先 | 1箇所の設定ファイルで変更可能 |
| モデル | freezedによるコード生成で型安全性を担保 |
| 状態管理 | Riverpodで統一。Widgetから直接API通信しない |
| ファイル構成 | 役割別にディレクトリを分割（models / providers / screens / widgets） |

### 8.5 セキュリティ要件

| 項目 | 現状 | 将来的な対応案 |
|---|---|---|
| 通信暗号化 | HTTP（非暗号化） | HTTPS化を推奨 |
| 認証 | なし | 必要に応じてAPI Key等を導入 |
| データ保護 | 閲覧専用のため低リスク | - |

---

## 9. 用語集

> **このセクションの目的：** ドメイン（業務領域）特有の用語や、プロジェクト内での独自の言葉遣いを定義する。「その言葉、何を指してる？」という認識のズレを防ぐ。

| 用語 | 意味 |
|---|---|
| グレード | レースの格付け。G1が最高位、G2、G3の順。G1レースには賞金が高く有名な馬が出走する |
| 芝 / ダート | コース（走路）の種別。芝は天然芝のコース、ダートは砂のコース |
| 着順 | レースの結果順位。1着が優勝 |
| 出走 | レースに参加すること。「出走数」はその馬が参加したレースの回数 |
| アクティブ | このアプリにおいて「去年または今年に出走がある」状態を指す |
| 前方一致 | 検索方式の一つ。入力した文字列で「始まる」データだけを絞り込む（例: "ア" → "アーモンドアイ" はヒット、"イクイノックス" はヒットしない） |
| サジェスト | テキスト入力中にリアルタイムで表示される入力候補のこと |
| Provider | Riverpodの仕組み。データの取得・保持・配信を担当する部品 |
| freezed | Dartのコード生成ライブラリ。イミュータブル（変更不可）なモデルクラスを自動生成する |

---

## 改訂履歴

| 版 | 日付 | 内容 |
|---|---|---|
| 1.0 | 2026-02-08 | 初版作成 |
